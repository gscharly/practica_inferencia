---
title: "Práctica Inferencia"
author: " "
date: "9 de noviembre de 2019"
output: 
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(plyr)
library(knitr)
```

### Lectura del conjunto de datos seleccionado

El conjunto de datos seleccionado contiene información acerca del número de suicidios según sexo y edad (dividido en seis grupos de edad) ocurridos en 101 países (ver tabla 1 en Anexo) desde 1985 hasta 2016. Además de esto, para cada año aparece el PIB del país y el PIB per cápita. Este conjunto de datos también cuenta con el índice de desarrollo humano. 

```{r data}
dataset <- read.csv(file="suicides.csv", header=TRUE, sep=",")

#seleccionamos solo aquellas columnas que tienen interés para el análisis
columnas_deseadas <- c('country', 'year', 'sex', 'age', 'suicides_no', 'population', 'suicides.100k.pop', 'country.year', 'gdp_for_year....', 'gdp_per_capita....')
suicides <- dataset[columnas_deseadas]

#renombramos las columnas para facilitar la comprensión
names(suicides)[1:10] <- c('country', 'year', 'sex', 'age', 'suicides_no', 'population', 'suicides_100k_pop', 'HDI_for_year', 'gdp_for_year ($)', 'gdp_per_capita ($)')

knitr::kable(head(suicides, 10), caption = 'Tabla 1. Primeras 10 filas del conjunto de datos')
```

### Justificación e hipótesis

Según la Organización Mundial de la Salud (OMS, 2019) cerca de 800.000 personas se suicidad al año (OMS, 2019). Dentro de este fenómeno pueden encontrarse factores de riesgo de caracter individual y social. 

En este sentido, los estudios muestran cómo el nivel socioeconómico y el género forman parte de dichos factores. 

La tasa de ideación suicida y los intentos de suicidio son mayores en mujeres. A pesar de esto, la frecuencia de suicidio entre los hombres es mayor pudiendo deberse al uso de mecanismos más letales (Mejía, Sanhuenza y González, 2011).

Por otro lado, el nivel económico parece tomar papel en esta diferencia entre ambos géneros. En los países de altos ingresos, se suicidan tres veces más hombres que mujeres, pero en los de ingresos bajos y medianos la razón, hombre: mujer es mucho menor, de 1,5 hombres por cada mujer (Corona, Hernández y García, 2016). 


### Muestreo del conjunto de datos

Basándonos en la bibliografía anterior, se plantea comparar el número de suicidios entre hombres y mujeres para todos los países y años conjuntamente. 

De esta forma, empezaremos dividiendo el archivo y creando dos subpoblaciones.

```{r subpoblaciones}
pobFemale <- subset(suicides, sex == 'female')
pobMale <- subset(suicides, sex == 'male')

#Comprobando cual es la proporción de hombres frente a mujeres de cara al muestreo
femalePerc <- (length(pobFemale$sex))/(length(suicides$sex))*100
malePerc <- (length(pobMale$sex))/(length(suicides$sex))*100

```
```{r print1, echo=FALSE}
sprintf('De la población total el %i %% son mujeres y el otro %i %% son hombres. Cada una de las subpoblaciones tienen %i sujetos.', femalePerc, malePerc, length(pobMale$sex))
```

A continuación se va a realizar el muestreo de ambas subpoblaciones. Se va a llevar a cabo un muestreo estratificado. Para elegir el tamaño muestral de cada estrato (afijación de la muestra), vamos a tener en cuenta que se van a realizar estimaciones sobre la media del número de suicidios en mujeres y hombres. Además se sabe que las subpoblaciones están compuestas por 13.910 observaciones cada una.

```{r muestreo}
set.seed(1)
N <- 13910
err <- 0.05
conf <- 0.9
alpha <- 1 - conf
varM <- var(pobMale$suicides_no)
varF <- var(pobFemale$suicides_no)
nM <- (N*varM*(qnorm(1 - alpha/2))^2)/((err^2)*(N-1) + (qnorm(1 - alpha/2)^2)*varM)
nF <- (N*varF*(qnorm(1 - alpha/2))^2)/((err^2)*(N-1) + (qnorm(1 - alpha/2)^2)*varF)

datosFemale <- pobFemale[sample(nrow(pobFemale),nF),]
datosMale <- pobMale[sample(nrow(pobMale),nM),]

print(summary(datosFemale$suicides_no))
print(summary(datosMale$suicides_no))

```


Se puede observar que el valor de la mediana está bastante alejado del valor de la media para ambas muestras, lo que nos indica que aparecen datos de suicidios muy extremos (outliers) que afectan bastante a dicho valor. Esto podría deberse a factores como la existencia en el dataset de países cuya población es muy superior a la de otros también presentes. A continuación se va a comprobar este hecho de manera sencilla filtrando la muestra (correspondiente a las mujeres) para quedarnos con los outliers.

```{r suicideoutliers}
female_quantiles = quantile(datosFemale$suicides_no,probs = c(0.25,0.75))
outlier_treshold = as.numeric(female_quantiles[2]) + 1.5*(as.numeric(female_quantiles[2]) - as.numeric(female_quantiles[1]))
female_outliers = datosFemale[datosFemale$suicides_no > outlier_treshold,]
```
```{r print2, echo=FALSE}
sprintf('El subconjunto de outliers está compuesto de %i elementos, representando el %.3f%% de la muestra total.', nrow(female_outliers),dim(female_outliers)[1]/nF)
```
A continuación se muestra una tabla con los 10 países que aparecen en más ocasiones dentro del conjunto de outliers de la muestra, junto al número de veces que aparecen:

```{r paisesoutliers}
tab <- as.data.frame(sort(table(female_outliers$country), decreasing = TRUE)[1:10])
names(tab)[1]<-"Country"
knitr::kable(tab, caption = 'Tabla 2. Top 10 outliers')
```
Se puede ver que se trata de países con poblaciones bastante altas en general. Como última comprabación, vamos ver como varía la media de la población en el subconjunto de outliers con respecto a la muestra total:

```{r print3, echo=FALSE}
sprintf('La población media en los outliers es %.2f, mientras que la muestra total es tan solo de %.2f.', mean(female_outliers$population),mean(datosFemale$population))
```
Algo similar sucede si realizamos este mismo análisis sobre la muestra de hombres. Con este sencillo análisis se ha podido comprobar que la aparición de valores tan dispares en la muestra se debe a la diferencia en cuanto a población entre los países del conjunto. Por ello, se ha optado por realizar nuestro análisis sobre el número de suicidios por cada 100.000 habitantes en lugar de hacerlo directamente sobre el número de suicidios como se había comentado previamente.

Como la varianza de la variable de interés presumiblemente será difente, se hace necesario muestrear de nuevo las subpoblaciones:

```{r muestreo2}
set.seed(1)
N <- 13910
err <- 0.05
conf <- 0.9
alpha <- 1 - conf
varM <- var(pobMale$suicides_100k_pop)
varF <- var(pobFemale$suicides_100k_pop)
nM <- (N*varM*(qnorm(1 - alpha/2))^2)/((err^2)*(N-1) + (qnorm(1 - alpha/2)^2)*varM)
nF <- (N*varF*(qnorm(1 - alpha/2))^2)/((err^2)*(N-1) + (qnorm(1 - alpha/2)^2)*varF)

datosFemale <- pobFemale[sample(nrow(pobFemale),nF),]
datosMale <- pobMale[sample(nrow(pobMale),nM),]

```

A continuación se muestran ciertos estadísticos calculados sobre ambas muestras para el número de suicidios por cada 100.000 habitantes:
```{r summarysuicides, echo=FALSE}
print(summary(datosFemale$suicides_100k_pop))
print(summary(datosMale$suicides_100k_pop))
```
Podemos ver que a pesar de que siguen apareciendo outliers, los datos se distribuyen de una manera mucho más uniforme. Esto se ve también reflejado en el siguiente diagrama de cajas:

```{r boxplot2}
boxplot(datosFemale$suicides_100k_pop, datosMale$suicides_100k_pop,
main = "Comparativa suicidios mujeres-hombres por 100k habitantes",
names = c("Mujeres", "Hombres"),
las = 2,
col = c("aquamarine","aquamarine1"),
border = "black",
horizontal = F,
ylab = 'suicidios por 100k hab.',
notch = TRUE,
outline = F
)

```
### Hipótesis

Después de la división en subpoblaciones, planteamos la siguiente hipótesis de acuerdo a los estudios.

H ~0~ = $\mu$ ~hombres~ >= $\mu$ ~mujeres~
H ~1~ = $\mu$ ~hombres~ < $\mu$ ~mujeres~

### Estimación puntual e intervalos de confianza

```{r estimaciónMediaMujeres}

#IC de la media dada con varianza poblacional conocida y confianza de 0.9
conf = 0.9
alpha = 1 - conf
mediaF=mean(datosFemale$suicides_100k_pop)
desvF=sqrt(var(pobFemale$suicides_100k_pop))

ci=mediaF-qnorm(1 - alpha/2)*desvF/sqrt(dim(datosFemale)[1])
cs=mediaF+qnorm(1 - alpha/2)*desvF/sqrt(dim(datosFemale)[1])
```
```{r print4}
sprintf('El intervalo de confianza para la media de suicidios por cada 100 mil habitantes en mujeres con $\alpha$ = 0.1 es: (%f,%f)', ci, cs)


#Revisar escribir alpha ahí dentro
```
```{r estimaciónMediaHombres}

#IC de la media con varianza poblacional conocida y confianza de 0.9
mediaM=mean(datosMale$suicides_100k_pop)
desvM=sqrt(var(pobMale$suicides_100k_pop))

#confianza de 0.90 
ci=mediaM-qnorm(1 - alpha/2)*desvM/sqrt(dim(datosMale)[1])
cs=mediaM+qnorm(1 - alpha/2)*desvM/sqrt(dim(datosMale)[1])
```
```{r print5}
sprintf('El intervalo de confianza para la media de suicidios por cada 100 mil habitantes en hombres con $\alpha$ = 0.1 es: (%f,%f)', ci, cs)

#Revisar escribir alpha ahí dentro
```
## Intervalo de confianza para la comparación medias

Se va a proporcionar un intervalo de confianza para la diferencia de medias en cuanto a número de suicidios por cada 100.000 habitantes entre mujeres y hombres. El parámetro que se estima sería $\theta$ = $\mu_{hombres}$ - $\mu_{mujeres}$.

```{r iccomparacionmedias}
#IC de la diferencia de medias con varianza diferentes pero conocidas y confianza de 0.9

meanF = mean(datosFemale$suicides_100k_pop)
meanM = mean(datosMale$suicides_100k_pop)
varF = var(datosFemale$suicides_100k_pop)
varM = var(datosMale$suicides_100k_pop)
nF = dim(datosFemale)[1]
nM = dim(datosMale)[1]

ci=((meanM-meanF)-qnorm(1 - alpha/2)*sqrt(varM/nM+varF/nF))
cs=((meanM-meanF)+qnorm(1 - alpha/2)*sqrt(varM/nM+varF/nF))

```
```{r print6}
sprintf('El intervalo de confianza para la diferencia en la media de suicidios por cada 100 mil habitantes entre hombres y mujeres con $\alpha$ = 0.1 es: (%f,%f)', ci, cs)

#Revisar escribir alpha ahí dentro
```
## Contraste de hipótesis para la característica de estudio en una de las muestras

Se realiza un contraste para estudiar si la media de suicidios por cada 100.000 en la muestra de hombres es igual a dicha característica pero en la muestra total (compuesta por hombres y mujeres). En este caso, las hipótesis a contrastar serían las siguientes:

H ~0~ = $\mu$ ~hombres~ = $\mu$ ~mujeres+hombres~
\newline H ~1~ != $\mu$ ~hombres~ < $\mu$ ~mujeres+hombres~

En este caso se va a suponer la varianza poblacional como conocida, a pesar de que este caso no se suela dar en entornos reales.

```{r contrastecaracterística}
datosTotales <- rbind(datosFemale,datosMale)
(est<-abs((mean(datosMale$suicides_100k_pop)-mean(datosTotales$suicides_100k_pop))/sqrt(var(pobMale$suicides_100k_pop)/nM)))
(rechazo<-(est>=qnorm(1 - alpha/2)))
```

### Contraste de hipótesis de normalidad para una de las muestras

Se va a analizar si los datos del número de suicidios por cada 100.000 habitantes en la muestra de hombres se ajusta una distribución normal. Para ello se va a hacer uso del test de Kolmogorov-Smirnov. En este test, las hipótesis a contrastar son las siguientes:

H ~0~ = los datos se ajustan a una distribución normal 

\newline H ~1~ = los datos no se ajustan a una distribución normal

```{r testnormalidad}
ks.test(x = datosMale$suicides_100k_pop,'pnorm',mean(datosMale$suicides_100k_pop),sd(datosMale$suicides_100k_pop))

```

El p-valor obtenido por el test es muy pequeño, por lo que podemos rechazar la hipótesis nula. 

### Contraste de hipótesis para la comparación de las muestras

```{r tstudent}
t.test(datosFemale$suicides_no, datosMale$suicides_no, alternative = 'less', conf.level = 0.90)

```

### Anexo
```{r tabla1, echo=FALSE}
knitr::kable(unique(suicides$country), caption = 'Tabla 1. Países incluídos en la base de datos')
```

### Referencias

** Corona, B., Hernández, M., y García, R. M. (2016). Mortalidad por suicidio, factores de riesgos y protectores. Revista Habanera de Ciencias Médicas, 15(1).

** Mejía, M., Sanhuenza, P., y González, J. (2011). Factores de riesgo y contexto del suicidio. Revista Memoriza, 8, 15-25.

** OMS (2019). Organización Mundial de la Salud. https://www.who.int/es/news-room/fact-sheets/detail/suicide




